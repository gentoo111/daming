name: CI/CD - å¤§æ˜å¸å›½å®˜ç½‘

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: å®‰è£…ä¾èµ–
      run: yarn install --frozen-lockfile
      
    - name: TypeScriptç±»å‹æ£€æŸ¥
      run: yarn tsc --noEmit
      
    - name: ESLintä»£ç è§„èŒƒæ£€æŸ¥
      run: yarn lint
      
    - name: æ„å»ºæµ‹è¯•
      run: yarn build
      
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: yarn audit --level moderate
      continue-on-error: true
      
  build-test:
    name: æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ  
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: å®‰è£…ä¾èµ–
      run: yarn install --frozen-lockfile
      
    - name: ç”Ÿäº§ç¯å¢ƒæ„å»º
      run: yarn build
      
    - name: æ£€æŸ¥æ„å»ºäº§ç‰©
      run: |
        if [ ! -d ".next" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ°.nextç›®å½•"
          exit 1
        fi
        echo "âœ… æ„å»ºæˆåŠŸ"
        
    - name: æ„å»ºäº§ç‰©å¤§å°åˆ†æ
      run: |
        echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°åˆ†æï¼š"
        du -sh .next/ || echo "æ— æ³•åˆ†æ.nextç›®å½•å¤§å°"
        
  notify:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [quality-check, build-test]
    if: always()
    
    steps:
    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      if: ${{ needs.quality-check.result == 'success' && needs.build-test.result == 'success' }}
      run: |
        echo "ğŸ‰ å¤§æ˜å¸å›½å®˜ç½‘æ„å»ºæˆåŠŸï¼"
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
        echo "âœ… æ„å»ºæµ‹è¯•é€šè¿‡" 
        echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°Cloudflare Pages"
        
    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: ${{ needs.quality-check.result == 'failure' || needs.build-test.result == 'failure' }}
      run: |
        echo "âŒ å¤§æ˜å¸å›½å®˜ç½‘æ„å»ºå¤±è´¥ï¼"
        echo "ğŸ” è¯·æ£€æŸ¥ä»£ç è´¨é‡æˆ–æ„å»ºé”™è¯¯"
        exit 1